#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Running pre-push validation..."

# 1. Type checking
echo "ğŸ“ Type checking..."
pnpm run typecheck
if [ $? -ne 0 ]; then
  echo "âŒ TypeScript errors found."
  exit 1
fi

# 2. Lint
echo "ğŸ§¹ Linting..."
pnpm run lint
if [ $? -ne 0 ]; then
  echo "âŒ Linting errors found."
  exit 1
fi

# 3. Prisma Generate & Validate
echo "ğŸ—„ï¸  Generating Prisma client and validating..."
pnpm prisma generate
pnpm prisma validate
if [ $? -ne 0 ]; then
  echo "âŒ Prisma validation failed."
  exit 1
fi

# 4. Run all unit tests
echo "ğŸ§ª Running unit tests..."
pnpm run test:unit --passWithNoTests
if [ $? -ne 0 ]; then
  echo "âŒ Unit tests failed."
  exit 1
fi

# 5. Run integration tests (if they exist)
echo "ğŸ”— Running integration tests..."
pnpm run test:integration --passWithNoTests
if [ $? -ne 0 ]; then
  echo "âŒ Integration tests failed."
  exit 1
fi

# 6. Build validation
echo "ğŸ—ï¸  Testing production build..."
pnpm run build:no-typecheck
if [ $? -ne 0 ]; then
  echo "âŒ Production build failed."
  exit 1
fi

# 7. Optional: Run e2e tests (comment out if too slow for regular pushes)
# These are typically slow, so only enable for critical branches or before merging to main
# echo "ğŸ­ Running e2e tests..."
# pnpm run test:e2e
# if [ $? -ne 0 ]; then
#   echo "âŒ E2E tests failed."
#   exit 1
# fi

echo "âœ… All pre-push checks passed! Safe to push."
echo ""
echo "ğŸ’¡ Next steps:"
echo "   - Create a PR using the GitHub template"
echo "   - Before merging to main, run: pnpm run deploy:pre-checks"
