generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["relationJoins"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  schemas   = ["public", "auth"]
}

model Profile {
  id                  String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  guid                String?
  name                String?
  email               String            @unique
  image               String?
  type                UserType          @default(VENDOR)
  companyName         String?
  contactName         String?
  contactNumber       String?
  website             String?
  street1             String?
  street2             String?
  city                String?
  state               String?
  zip                 String?
  locationNumber      String?
  parkingLoading      String?
  counties            Json?
  timeNeeded          String?
  cateringBrokerage   String?
  frequency           String?
  provide             String?
  headCount           Int?
  status              UserStatus        @default(PENDING)
  sideNotes           String?
  confirmationCode    String?
  createdAt           DateTime          @default(now()) @db.Timestamptz(6)
  updatedAt           DateTime          @default(now()) @updatedAt @db.Timestamptz(6)
  isTemporaryPassword Boolean           @default(false)
  deletedAt           DateTime?         @db.Timestamptz(6)
  deletedBy           String?           @db.Uuid
  deletionReason      String?
  accounts            Account[]
  createdAddresses    Address[]         @relation("AddressCreatedBy")
  cateringRequests    CateringRequest[]
  driverDispatches    Dispatch[]        @relation("DriverDispatch")
  userDispatches      Dispatch[]        @relation("UserDispatch")
  fileUploads         FileUpload[]
  jobApplications     JobApplication[]  @relation("ProfileToJobApplication")
  onDemandRequests     OnDemand[]
  sessions             Session[]
  userAddresses        UserAddress[]
  deletedByUser        Profile?                @relation("UserDeletedBy", fields: [deletedBy], references: [id])
  deletedUsers         Profile[]               @relation("UserDeletedBy")
  auditLogs            UserAudit[]
  performedAudits      UserAudit[]             @relation("UserAuditPerformer")
  clientConfigurations ClientConfiguration[]   @relation("ClientConfigurations")
  calculationHistory   CalculationHistory[]    @relation("CalculationHistory")
  driverRecord          Driver?                 @relation("DriverProfile")
  assignedDeliveries    Delivery[]              @relation("DeliveryAssigner")
  emailPreferences          EmailPreferences?
  hasPushNotifications      Boolean                   @default(false) @map("has_push_notifications")
  pushTokens                ProfilePushToken[]
  notificationAnalytics     NotificationAnalytics[]

  @@index([email])
  @@index([type])
  @@index([status])
  @@index([deletedAt])
  @@index([deletedBy])
  @@index([type, deletedAt]) // Dashboard vendor counting optimization
  @@schema("public")
  @@map("profiles")
}

model UserAudit {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @db.Uuid
  action      String   // CREATE, UPDATE, DELETE, RESTORE, etc.
  performedBy String?  @db.Uuid
  changes     Json?    // Store the changes made (before/after values)
  reason      String?  // Reason for the action
  metadata    Json?    // Additional metadata
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  
  user        Profile  @relation(fields: [userId], references: [id], onDelete: Cascade)
  performer   Profile? @relation("UserAuditPerformer", fields: [performedBy], references: [id])

  @@index([userId])
  @@index([action])
  @@index([performedBy])
  @@index([createdAt])
  @@schema("public")
  @@map("user_audits")
}

model EmailPreferences {
  id                    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId                String   @unique @db.Uuid
  deliveryNotifications Boolean  @default(true) @map("delivery_notifications")
  promotionalEmails     Boolean  @default(false) @map("promotional_emails")
  createdAt             DateTime @default(now()) @db.Timestamptz(6) @map("created_at")
  updatedAt             DateTime @default(now()) @updatedAt @db.Timestamptz(6) @map("updated_at")

  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@schema("public")
  @@map("email_preferences")
}

/// Stores FCM push notification tokens for each user device.
/// Used for browser push notifications via Firebase Cloud Messaging.
model ProfilePushToken {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  profileId       String    @db.Uuid @map("profile_id")
  token           String    @unique
  userAgent       String?   @map("user_agent")
  platform        String?
  createdAt       DateTime  @default(now()) @db.Timestamptz(6) @map("created_at")
  revokedAt       DateTime? @db.Timestamptz(6) @map("revoked_at")
  lastRefreshedAt DateTime  @default(now()) @db.Timestamptz(6) @map("last_refreshed_at")
  refreshCount    Int       @default(0) @map("refresh_count")

  profile Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([profileId, revokedAt])
  @@index([lastRefreshedAt])
  @@schema("public")
  @@map("profile_push_tokens")
}

/// Tracks notification analytics for push and email notifications.
/// Used for monitoring delivery rates, failures, and user engagement.
model NotificationAnalytics {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  profileId        String    @db.Uuid @map("profile_id")
  notificationType String    @map("notification_type") // 'push' | 'email'
  event            String    // 'delivery:assigned', 'driver:en_route', etc.
  recipientType    String    @map("recipient_type") // 'CUSTOMER' | 'ADMIN' | 'STORE'
  orderId          String?   @db.Uuid @map("order_id")
  dispatchId       String?   @db.Uuid @map("dispatch_id")
  status           String    @default("sent") // 'sent' | 'delivered' | 'failed' | 'clicked'
  errorMessage     String?   @map("error_message")
  fcmMessageId     String?   @map("fcm_message_id")
  createdAt        DateTime  @default(now()) @db.Timestamptz(6) @map("created_at")
  deliveredAt      DateTime? @db.Timestamptz(6) @map("delivered_at")
  clickedAt        DateTime? @db.Timestamptz(6) @map("clicked_at")

  profile Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([createdAt])
  @@index([status])
  @@index([notificationType, status])
  @@index([recipientType, createdAt])
  @@schema("public")
  @@map("notification_analytics")
}

/// Distributed notification deduplication table.
/// Replaces in-memory cache for multi-instance support.
model NotificationDedup {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  cacheKey  String   @unique @map("cache_key") // "{profileId}:{event}:{orderId}"
  createdAt DateTime @default(now()) @db.Timestamptz(6) @map("created_at")

  @@index([cacheKey])
  @@index([createdAt])
  @@schema("public")
  @@map("notification_dedup")
}

model Account {
  id                String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String  @db.Uuid
  type              String
  provider          String
  providerAccountId String
  refreshToken      String?
  accessToken       String?
  expiresAt         Int?
  tokenType         String?
  scope             String?
  idToken           String?
  sessionState      String?
  user              Profile @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@schema("public")
  @@map("accounts")
}

model Session {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionToken String   @unique
  userId       String   @db.Uuid
  expires      DateTime @db.Timestamptz(6)
  user         Profile  @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([userId])
  @@schema("public")
  @@map("sessions")
}

model Address {
  id                       String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  county                   String?
  street1                  String
  street2                  String?
  city                     String
  state                    String
  zip                      String
  createdAt                DateTime          @default(now()) @db.Timestamptz(6)
  createdBy                String?           @db.Uuid
  isRestaurant             Boolean           @default(false)
  isShared                 Boolean           @default(false)
  locationNumber           String?
  parkingLoading           String?
  updatedAt                DateTime          @default(now()) @updatedAt @db.Timestamptz(6)
  name                     String?
  latitude                 Float?
  longitude                Float?
  deletedAt                DateTime?         @db.Timestamptz(6)
  creator                  Profile?          @relation("AddressCreatedBy", fields: [createdBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  cateringDeliveryRequests CateringRequest[] @relation("CateringDelivery")
  cateringPickupRequests   CateringRequest[] @relation("CateringPickup")
  onDemandDeliveryRequests OnDemand[]        @relation("OnDemandDelivery")
  onDemandPickupRequests   OnDemand[]        @relation("OnDemandPickup")
  userAddresses            UserAddress[]

  @@index([createdBy])
  @@index([city, state])
  @@schema("public")
  @@map("addresses")
}

model PricingTier {
  id                   String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  minHeadCount         Int
  maxHeadCount         Int?
  minFoodCost          Decimal           @db.Decimal(10, 2)
  maxFoodCost          Decimal?          @db.Decimal(10, 2)
  priceWithTip         Decimal?          @db.Decimal(10, 2)
  priceWithoutTip      Decimal?          @db.Decimal(10, 2)
  percentageWithTip    Decimal?          @db.Decimal(5, 2)
  percentageWithoutTip Decimal?          @db.Decimal(5, 2)
  isActive             Boolean           @default(true)
  createdAt            DateTime          @default(now()) @db.Timestamptz(6)
  updatedAt            DateTime          @default(now()) @updatedAt @db.Timestamptz(6)
  cateringRequests     CateringRequest[]

  @@index([minHeadCount, minFoodCost])
  @@index([isActive])
  @@schema("public")
  @@map("pricing_tiers")
}

model CateringRequest {
  id                String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  guid              String?
  userId            String           @db.Uuid
  pickupAddressId   String           @db.Uuid
  deliveryAddressId String           @db.Uuid
  brokerage         String?
  orderNumber       String           @unique
  pickupDateTime    DateTime?        @db.Timestamptz(6)
  arrivalDateTime   DateTime?        @db.Timestamptz(6)
  completeDateTime  DateTime?        @db.Timestamptz(6)
  headcount         Int?
  needHost          CateringNeedHost @default(NO)
  hoursNeeded       Float?
  numberOfHosts     Int?
  clientAttention   String?
  pickupNotes       String?
  specialNotes      String?
  image             String?
  status            CateringStatus   @default(ACTIVE)
  orderTotal        Decimal?         @default(0.00) @db.Decimal(10, 2)
  tip               Decimal?         @default(0.00) @db.Decimal(10, 2)
  appliedDiscount   Decimal?         @db.Decimal(10, 2)
  pricingTierId     String?          @db.Uuid
  deliveryCost      Decimal?         @db.Decimal(10, 2)
  deliveryDistance  Decimal?         @db.Decimal(10, 2)
  createdAt         DateTime         @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime         @default(now()) @updatedAt @db.Timestamptz(6)
  driverStatus      DriverStatus?
  ezCaterDeliveryId String?          @map("ezcater_delivery_id")
  deletedAt         DateTime?        @db.Timestamptz(6)
  archivedAt        DateTime?        @map("archived_at") @db.Timestamptz(6)
  archiveBatchId    String?          @map("archive_batch_id") @db.Uuid
  deliveryAddress   Address          @relation("CateringDelivery", fields: [deliveryAddressId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  pickupAddress     Address          @relation("CateringPickup", fields: [pickupAddressId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  pricingTier       PricingTier?     @relation(fields: [pricingTierId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  user              Profile          @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  archiveBatch      ArchiveBatch?    @relation(fields: [archiveBatchId], references: [id], onDelete: SetNull)
  dispatches        Dispatch[]
  fileUploads       FileUpload[]

  @@index([userId])
  @@index([status])
  @@index([pickupDateTime])
  @@index([userId, status])
  @@index([deliveryAddressId, pickupDateTime])
  @@index([pricingTierId])
  @@index([status, createdAt]) // Dashboard metrics optimization
  @@index([status, createdAt, orderTotal]) // Dashboard revenue aggregation
  @@index([archivedAt])
  @@index([archiveBatchId])
  @@schema("public")
  @@map("catering_requests")
}

model Dispatch {
  id                String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  cateringRequestId String?          @db.Uuid
  createdAt         DateTime         @default(now()) @db.Timestamptz(6)
  driverId          String?          @db.Uuid
  onDemandId        String?          @db.Uuid
  updatedAt         DateTime         @default(now()) @updatedAt @db.Timestamptz(6)
  userId            String?          @db.Uuid
  cateringRequest   CateringRequest? @relation(fields: [cateringRequestId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  driver            Profile?         @relation("DriverDispatch", fields: [driverId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  onDemand          OnDemand?        @relation(fields: [onDemandId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  user              Profile?         @relation("UserDispatch", fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([driverId])
  @@index([cateringRequestId])
  @@index([onDemandId])
  @@schema("public")
  @@map("dispatches")
}

model FileUpload {
  id                String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String?          @db.Uuid
  fileName          String
  fileType          String
  fileSize          Int
  fileUrl           String
  filePath          String?          // Storage path for generating signed URLs
  uploadedAt        DateTime         @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime         @default(now()) @updatedAt @db.Timestamptz(6)
  cateringRequestId String?          @db.Uuid
  onDemandId        String?          @db.Uuid
  jobApplicationId  String?          @db.Uuid
  category          String?
  isTemporary       Boolean          @default(false)
  cateringRequest   CateringRequest? @relation(fields: [cateringRequestId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  jobApplication    JobApplication?  @relation(fields: [jobApplicationId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  onDemand          OnDemand?        @relation(fields: [onDemandId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user              Profile?         @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([userId])
  @@index([cateringRequestId])
  @@index([onDemandId])
  @@index([jobApplicationId])
  @@index([fileType])
  @@schema("public")
  @@map("file_uploads")
}

model UploadError {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  correlationId String  @unique
  errorType    String
  message      String
  userMessage  String
  details      String?
  userId       String?  @db.Uuid
  timestamp    DateTime @default(now()) @db.Timestamptz(6)
  retryable    Boolean  @default(false)
  resolved     Boolean  @default(false)

  @@index([userId])
  @@index([errorType])
  @@index([timestamp])
  @@schema("public")
  @@map("upload_errors")
}

model OnDemand {
  id                String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  guid              String?
  userId            String         @db.Uuid
  pickupAddressId   String         @db.Uuid
  deliveryAddressId String         @db.Uuid
  orderNumber       String         @unique
  pickupDateTime    DateTime       @db.Timestamptz(6)
  arrivalDateTime   DateTime       @db.Timestamptz(6)
  completeDateTime  DateTime?      @db.Timestamptz(6)
  hoursNeeded       Float?
  itemDelivered     String?
  vehicleType       VehicleType    @default(CAR)
  clientAttention   String
  pickupNotes       String?
  specialNotes      String?
  image             String?
  status            OnDemandStatus @default(ACTIVE)
  orderTotal        Decimal?       @default(0.00) @db.Decimal(10, 2)
  tip               Decimal?       @default(0.00) @db.Decimal(10, 2)
  length            Float?
  width             Float?
  height            Float?
  weight            Float?
  createdAt         DateTime       @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime       @default(now()) @updatedAt @db.Timestamptz(6)
  driverStatus      DriverStatus?
  deletedAt         DateTime?      @db.Timestamptz(6)
  archivedAt        DateTime?      @map("archived_at") @db.Timestamptz(6)
  archiveBatchId    String?        @map("archive_batch_id") @db.Uuid
  dispatches        Dispatch[]
  fileUploads       FileUpload[]
  deliveryAddress   Address        @relation("OnDemandDelivery", fields: [deliveryAddressId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  pickupAddress     Address        @relation("OnDemandPickup", fields: [pickupAddressId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  user              Profile        @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  archiveBatch      ArchiveBatch?  @relation(fields: [archiveBatchId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([status])
  @@index([pickupDateTime])
  @@index([vehicleType])
  @@index([userId, status])
  @@index([archivedAt])
  @@index([archiveBatchId])
  @@schema("public")
  @@map("on_demand_requests")
}

model UserAddress {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @db.Uuid
  addressId String   @db.Uuid
  alias     String?
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(6)
  address   Address  @relation(fields: [addressId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user      Profile  @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([userId, addressId])
  @@index([userId])
  @@index([addressId])
  @@schema("public")
  @@map("user_addresses")
}

model VerificationToken {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  identifier String
  token      String   @unique
  expires    DateTime @db.Timestamptz(6)

  @@unique([identifier, token])
  @@index([token])
  @@schema("public")
  @@map("verification_tokens")
}

model FormSubmission {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt          DateTime @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime @default(now()) @updatedAt @db.Timestamptz(6)
  formType           FormType
  companyName        String
  contactName        String
  email              String
  phone              String
  website            String
  counties           Json
  frequency          String
  pickupAddress      Json
  additionalComments String
  specifications     String

  @@index([formType])
  @@index([email])
  @@schema("public")
  @@map("form_submissions")
}

model LeadCapture {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  firstName         String
  lastName          String
  email             String   @unique
  industry          String
  newsletterConsent Boolean  @default(false)
  createdAt         DateTime @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@index([email])
  @@index([industry])
  @@schema("public")
  @@map("lead_captures")
}

model JobApplication {
  id                     String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  profileId              String?           @db.Uuid
  firstName              String
  lastName               String
  email                  String
  phone                  String?
  position               String
  addressStreet          String
  addressCity            String
  addressState           String
  addressZip             String
  education              String?
  workExperience         String?
  skills                 String?
  coverLetter            String?
  resumeFilePath         String?
  driversLicenseFilePath String?
  insuranceFilePath      String?
  vehicleRegFilePath     String?
  foodHandlerFilePath    String?
  hipaaFilePath          String?
  driverPhotoFilePath    String?
  carPhotoFilePath       String?
  equipmentPhotoFilePath String?
  status                 ApplicationStatus @default(PENDING)
  createdAt              DateTime          @default(now()) @db.Timestamptz(6)
  updatedAt              DateTime          @default(now()) @updatedAt @db.Timestamptz(6)
  deletedAt              DateTime?         @db.Timestamptz(6)
  fileUploads            FileUpload[]
  profile                Profile?          @relation("ProfileToJobApplication", fields: [profileId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([email])
  @@index([status])
  @@index([position])
  @@schema("public")
  @@map("job_applications")
}

enum UserType {
  VENDOR
  CLIENT
  DRIVER
  ADMIN
  HELPDESK
  SUPER_ADMIN
  @@schema("public")
}

enum UserStatus {
  ACTIVE
  PENDING
  DELETED
  @@schema("public")
}

enum DriverStatus {
  ARRIVED_AT_VENDOR
  PICKED_UP
  EN_ROUTE_TO_CLIENT
  ARRIVED_TO_CLIENT
  ASSIGNED
  COMPLETED
  @@schema("public")
}

enum CateringNeedHost {
  YES
  NO
  @@schema("public")
}

enum CateringStatus {
  ACTIVE
  ASSIGNED
  CANCELLED
  COMPLETED
  PENDING
  CONFIRMED
  IN_PROGRESS
  DELIVERED
  @@schema("public")
}

enum OnDemandStatus {
  ACTIVE
  ASSIGNED
  CANCELLED
  COMPLETED
  PENDING
  CONFIRMED
  IN_PROGRESS
  DELIVERED
  @@schema("public")
}

enum VehicleType {
  CAR
  VAN
  TRUCK
  @@schema("public")
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
  INTERVIEWING
  @@schema("public")
}

enum FormType {
  FOOD
  FLOWER
  BAKERY
  SPECIALTY
  @@schema("public")
}

model CalculatorTemplate {
  id                   String               @id @default(uuid()) @db.Uuid
  name                 String
  description          String?
  isActive             Boolean              @default(true) @map("is_active")
  createdAt            DateTime             @default(now()) @db.Timestamptz(6) @map("created_at")
  updatedAt            DateTime             @updatedAt @db.Timestamptz(6) @map("updated_at")
  pricingRules         PricingRule[]
  clientConfigurations ClientConfiguration[]
  calculationHistory   CalculationHistory[]

  @@index([isActive])
  @@schema("public")
  @@map("calculator_templates")
}

model PricingRule {
  id             String             @id @default(uuid()) @db.Uuid
  templateId     String             @db.Uuid @map("template_id")
  ruleType       String             @map("rule_type") // 'customer_charge' or 'driver_payment'
  ruleName       String             @map("rule_name") // 'base_fee', 'mileage', 'toll', etc.
  baseAmount     Decimal?           @db.Decimal(10, 2) @map("base_amount")
  perUnitAmount  Decimal?           @db.Decimal(10, 2) @map("per_unit_amount")
  thresholdValue Decimal?           @db.Decimal(10, 2) @map("threshold_value")
  thresholdType  String?            @map("threshold_type") // 'above', 'below', 'between'
  appliesWhen    String?            @map("applies_when") // JSON string for complex conditions
  priority       Int                @default(0)
  createdAt      DateTime           @default(now()) @db.Timestamptz(6) @map("created_at")
  updatedAt      DateTime           @updatedAt @db.Timestamptz(6) @map("updated_at")
  template       CalculatorTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, ruleType, ruleName], name: "unique_template_rule")
  @@index([templateId])
  @@index([ruleType])
  @@schema("public")
  @@map("pricing_rules")
}

model ClientConfiguration {
  id                 String               @id @default(uuid()) @db.Uuid
  clientId           String?              @db.Uuid @map("client_id")
  templateId         String               @db.Uuid @map("template_id")
  clientName         String               @map("client_name")
  ruleOverrides      Json                 @default("{}") @map("rule_overrides")
  areaRules          Json                 @default("[]") @map("area_rules")
  isActive           Boolean              @default(true) @map("is_active")
  createdAt          DateTime             @default(now()) @db.Timestamptz(6) @map("created_at")
  updatedAt          DateTime             @updatedAt @db.Timestamptz(6) @map("updated_at")
  client             Profile?             @relation("ClientConfigurations", fields: [clientId], references: [id])
  template           CalculatorTemplate   @relation(fields: [templateId], references: [id])
  calculationHistory CalculationHistory[]

  @@index([clientId])
  @@index([templateId])
  @@schema("public")
  @@map("client_configurations")
}

model CalculationHistory {
  id               String               @id @default(uuid()) @db.Uuid
  templateId       String?              @db.Uuid @map("template_id")
  clientConfigId   String?              @db.Uuid @map("client_config_id")
  userId           String?              @db.Uuid @map("user_id")
  inputData        Json                 @map("input_data")
  customerCharges  Json                 @map("customer_charges")
  driverPayments   Json                 @map("driver_payments")
  customerTotal    Decimal              @db.Decimal(10, 2) @map("customer_total")
  driverTotal      Decimal              @db.Decimal(10, 2) @map("driver_total")
  notes            String?
  createdAt        DateTime             @default(now()) @db.Timestamptz(6) @map("created_at")
  template         CalculatorTemplate?  @relation(fields: [templateId], references: [id])
  clientConfig     ClientConfiguration? @relation(fields: [clientConfigId], references: [id])
  user             Profile?             @relation("CalculationHistory", fields: [userId], references: [id])

  @@index([createdAt])
  @@index([userId])
  @@index([templateId])
  @@schema("public")
  @@map("calculation_history")
}

model Testimonial {
  id          String              @id @default(uuid()) @db.Uuid
  name        String
  role        String?
  content     String
  image       String?
  rating      Int                 @default(5)
  category    TestimonialCategory @default(CLIENTS)
  isActive    Boolean             @default(true) @map("is_active")
  sortOrder   Int                 @default(0) @map("sort_order")
  createdAt   DateTime            @default(now()) @db.Timestamptz(6) @map("created_at")
  updatedAt   DateTime            @updatedAt @db.Timestamptz(6) @map("updated_at")

  @@index([category, isActive, sortOrder])
  @@index([isActive])
  @@schema("public")
  @@map("testimonials")
}

enum TestimonialCategory {
  CLIENTS
  VENDORS
  DRIVERS
  @@schema("public")
}

model DeliveryConfiguration {
  id                    String   @id @default(uuid()) @db.Uuid
  configId              String   @unique @map("config_id") // e.g., 'ready-set-food-standard'
  clientName            String   @map("client_name")
  vendorName            String   @map("vendor_name")
  description           String?
  isActive              Boolean  @default(true) @map("is_active")

  // Pricing Settings (stored as JSON for flexibility)
  pricingTiers          Json     @map("pricing_tiers")
  mileageRate           Decimal  @db.Decimal(10, 2) @map("mileage_rate")
  distanceThreshold     Decimal  @db.Decimal(5, 2) @map("distance_threshold")

  // Daily Drive Discounts
  dailyDriveDiscounts   Json     @map("daily_drive_discounts")

  // Driver Pay Settings
  driverPaySettings     Json     @map("driver_pay_settings")

  // Bridge Toll Settings
  bridgeTollSettings    Json     @map("bridge_toll_settings")

  // Custom Settings (flexible for future additions)
  customSettings        Json?    @map("custom_settings")

  // Metadata
  createdAt             DateTime @default(now()) @db.Timestamptz(6) @map("created_at")
  updatedAt             DateTime @updatedAt @db.Timestamptz(6) @map("updated_at")
  createdBy             String?  @db.Uuid @map("created_by")
  notes                 String?

  @@index([configId])
  @@index([isActive])
  @@index([clientName])
  @@schema("public")
  @@map("delivery_configurations")
}

// ============================================================================
// Driver Tracking Models (REA-122)
// ============================================================================

model Driver {
  id                  String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId              String?             @db.Uuid @map("user_id")
  profileId           String?             @unique @db.Uuid @map("profile_id")
  employeeId          String?             @unique @map("employee_id") @db.VarChar(50)
  vehicleNumber       String?             @map("vehicle_number") @db.VarChar(50)
  phoneNumber         String?             @map("phone_number") @db.VarChar(20)
  isActive            Boolean             @default(true) @map("is_active")
  isOnDuty            Boolean             @default(false) @map("is_on_duty")
  shiftStartTime      DateTime?           @map("shift_start_time") @db.Timestamptz(6)
  shiftEndTime        DateTime?           @map("shift_end_time") @db.Timestamptz(6)
  currentShiftId      String?             @map("current_shift_id") @db.Uuid
  lastKnownLocation   Unsupported("geography(Point)")? @map("last_known_location")
  lastLocationUpdate  DateTime?           @map("last_location_update") @db.Timestamptz(6)
  lastKnownAccuracy   Float?              @map("last_known_accuracy")
  lastKnownSpeed      Float?              @map("last_known_speed")
  lastKnownHeading    Float?              @map("last_known_heading")
  createdAt           DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime            @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt           DateTime?           @map("deleted_at") @db.Timestamptz(6)

  profile             Profile?            @relation("DriverProfile", fields: [profileId], references: [id], onDelete: Cascade)
  locations           DriverLocation[]
  shifts              DriverShift[]
  deliveries          Delivery[]
  weeklySummaries     DriverWeeklySummary[]

  @@index([profileId])
  @@index([isActive])
  @@index([isOnDuty])
  @@index([lastLocationUpdate])
  @@index([deletedAt])
  @@schema("public")
  @@map("drivers")
}

model DriverLocation {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  driverId     String    @db.Uuid @map("driver_id")
  location     Unsupported("geography(Point)")
  latitude     Float
  longitude    Float
  accuracy     Float?
  speed        Float?
  heading      Float?
  altitude     Float?
  recordedAt   DateTime  @default(now()) @map("recorded_at") @db.Timestamptz(6)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  source       String?   @default("realtime") @db.VarChar(20)
  batteryLevel Int?      @map("battery_level")
  isMoving     Boolean?  @default(true) @map("is_moving")
  deletedAt    DateTime? @map("deleted_at") @db.Timestamptz(6)

  driver Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([driverId])
  @@index([recordedAt])
  @@index([createdAt])
  @@index([driverId, recordedAt])
  @@index([source])
  @@index([deletedAt])
  @@schema("public")
  @@map("driver_locations")
}

model DriverShift {
  id                     String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  driverId               String    @db.Uuid @map("driver_id")
  shiftStart             DateTime  @map("shift_start") @db.Timestamptz(6)
  shiftEnd               DateTime? @map("shift_end") @db.Timestamptz(6)
  plannedShiftDuration   String?   @map("planned_shift_duration") // Interval type
  actualShiftDuration    String?   @map("actual_shift_duration") // Interval type
  status                 String    @default("scheduled") @db.VarChar(20)
  startLocation          Unsupported("geography(Point)")? @map("start_location")
  endLocation            Unsupported("geography(Point)")? @map("end_location")
  startOdometer          Float?    @map("start_odometer")
  endOdometer            Float?    @map("end_odometer")
  totalDistance          Float?    @map("total_distance") // Legacy km field
  totalDistanceMiles     Float?    @map("total_distance_miles") // Primary distance in miles
  gpsDistanceMiles       Float?    @map("gps_distance_miles") // GPS-calculated for audit
  reportedDistanceMiles  Float?    @map("reported_distance_miles") // Client-reported
  mileageSource          String?   @map("mileage_source") @db.VarChar(20) // gps, odometer, manual, hybrid
  deliveryCount          Int?      @default(0) @map("delivery_count")
  breakStart             DateTime? @map("break_start") @db.Timestamptz(6)
  breakEnd               DateTime? @map("break_end") @db.Timestamptz(6)
  totalBreakDuration     String?   @map("total_break_duration") // Interval type
  notes                  String?
  createdAt              DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt              DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt              DateTime? @map("deleted_at") @db.Timestamptz(6)

  driver     Driver     @relation(fields: [driverId], references: [id], onDelete: Cascade)
  deliveries Delivery[]

  @@index([driverId])
  @@index([status])
  @@index([shiftStart])
  @@index([shiftEnd])
  @@index([driverId, status])
  @@index([deletedAt])
  @@schema("public")
  @@map("driver_shifts")
}

model Delivery {
  id                     String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  driverId               String?   @db.Uuid @map("driver_id")
  shiftId                String?   @db.Uuid @map("shift_id")
  assignedBy             String?   @db.Uuid @map("assigned_by")
  orderNumber            String?   @unique @map("order_number") @db.VarChar(100)
  customerName           String?   @map("customer_name") @db.VarChar(255)
  customerPhone          String?   @map("customer_phone") @db.VarChar(20)
  pickupAddress          String?   @map("pickup_address")
  pickupLocation         Unsupported("geography(Point)")? @map("pickup_location")
  deliveryAddress        String    @map("delivery_address")
  deliveryLocation       Unsupported("geography(Point)")? @map("delivery_location")
  status                 String    @default("pending") @db.VarChar(20)
  assignedAt             DateTime? @map("assigned_at") @db.Timestamptz(6)
  acceptedAt             DateTime? @map("accepted_at") @db.Timestamptz(6)
  arrivedAtVendorAt      DateTime? @map("arrived_at_vendor_at") @db.Timestamptz(6)
  pickedUpAt             DateTime? @map("picked_up_at") @db.Timestamptz(6)
  enRouteAt              DateTime? @map("en_route_at") @db.Timestamptz(6)
  arrivedAtClientAt      DateTime? @map("arrived_at_client_at") @db.Timestamptz(6)
  deliveredAt            DateTime? @map("delivered_at") @db.Timestamptz(6)
  cancelledAt            DateTime? @map("cancelled_at") @db.Timestamptz(6)
  estimatedPickupTime    DateTime? @map("estimated_pickup_time") @db.Timestamptz(6)
  estimatedDeliveryTime  DateTime? @map("estimated_delivery_time") @db.Timestamptz(6)
  priority               String?   @default("normal") @db.VarChar(20)
  deliveryInstructions   String?   @map("delivery_instructions")
  signatureRequired      Boolean?  @default(false) @map("signature_required")
  photoRequired          Boolean?  @default(false) @map("photo_required")
  deliverySignatureUrl   String?   @map("delivery_signature_url")
  deliveryPhotoUrl       String?   @map("delivery_photo_url")
  deliveryNotes          String?   @map("delivery_notes")
  createdAt              DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt              DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt              DateTime? @map("deleted_at") @db.Timestamptz(6)

  driver     Driver?      @relation(fields: [driverId], references: [id], onDelete: SetNull)
  shift      DriverShift? @relation(fields: [shiftId], references: [id], onDelete: SetNull)
  assigner   Profile?     @relation("DeliveryAssigner", fields: [assignedBy], references: [id], onDelete: SetNull)

  @@index([driverId])
  @@index([shiftId])
  @@index([assignedBy])
  @@index([status])
  @@index([assignedAt])
  @@index([deliveredAt])
  @@index([estimatedDeliveryTime])
  @@index([priority])
  @@index([orderNumber])
  @@index([driverId, status])
  @@index([deletedAt])
  @@schema("public")
  @@map("deliveries")
}

// ============================================================================
// Data Archiving Models (REA-313)
// ============================================================================

/// Tracks all data archiving operations for audit and retrieval purposes.
/// Each archiving job creates a batch record to track what was archived.
model ArchiveBatch {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  archiveType      String    @map("archive_type") @db.VarChar(50) // 'driver_locations', 'driver_shifts', 'orders'
  startedAt        DateTime  @default(now()) @map("started_at") @db.Timestamptz(6)
  completedAt      DateTime? @map("completed_at") @db.Timestamptz(6)
  status           String    @default("in_progress") @db.VarChar(20) // 'in_progress', 'completed', 'failed'
  recordsProcessed Int       @default(0) @map("records_processed")
  recordsArchived  Int       @default(0) @map("records_archived")
  recordsFailed    Int       @default(0) @map("records_failed")
  dateRangeStart   DateTime? @map("date_range_start") @db.Timestamptz(6)
  dateRangeEnd     DateTime? @map("date_range_end") @db.Timestamptz(6)
  retentionDays    Int       @map("retention_days")
  dryRun           Boolean   @default(false) @map("dry_run")
  errorMessage     String?   @map("error_message")
  metadata         Json      @default("{}")
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations to archived orders (soft archive)
  cateringRequests CateringRequest[]
  onDemandRequests OnDemand[]

  @@index([archiveType])
  @@index([status])
  @@index([startedAt])
  @@index([archiveType, startedAt])
  @@schema("public")
  @@map("archive_batches")
}

/// Pre-computed weekly aggregates for fast PDF generation and historical reporting.
/// Generated by the weekly summary job for each driver.
model DriverWeeklySummary {
  id                   String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  driverId             String   @map("driver_id") @db.Uuid
  weekStart            DateTime @map("week_start") @db.Date
  weekEnd              DateTime @map("week_end") @db.Date
  year                 Int
  weekNumber           Int      @map("week_number")

  // Shift metrics
  totalShifts          Int      @default(0) @map("total_shifts")
  completedShifts      Int      @default(0) @map("completed_shifts")
  cancelledShifts      Int      @default(0) @map("cancelled_shifts")
  totalShiftHours      Decimal  @default(0) @map("total_shift_hours") @db.Decimal(10, 2)
  totalBreakHours      Decimal  @default(0) @map("total_break_hours") @db.Decimal(10, 2)

  // Delivery metrics
  totalDeliveries      Int      @default(0) @map("total_deliveries")
  completedDeliveries  Int      @default(0) @map("completed_deliveries")
  cancelledDeliveries  Int      @default(0) @map("cancelled_deliveries")

  // Distance metrics
  totalMiles           Decimal  @default(0) @map("total_miles") @db.Decimal(10, 2)
  gpsMiles             Decimal  @default(0) @map("gps_miles") @db.Decimal(10, 2)
  reportedMiles        Decimal  @default(0) @map("reported_miles") @db.Decimal(10, 2)

  // Location data density
  locationPointsCount  Int      @default(0) @map("location_points_count")

  // Data source indicators
  dataSources          Json     @default("{}") @map("data_sources")

  // Metadata
  generatedAt          DateTime @default(now()) @map("generated_at") @db.Timestamptz(6)
  updatedAt            DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  generationBatchId    String?  @map("generation_batch_id") @db.Uuid

  driver Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@unique([driverId, weekStart])
  @@index([driverId])
  @@index([weekStart])
  @@index([year, weekNumber])
  @@index([driverId, year, weekNumber])
  @@index([generatedAt])
  @@schema("public")
  @@map("driver_weekly_summaries")
}
